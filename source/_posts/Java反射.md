---
title: Java反射
toc: true
date: 2017-03-22 10:35:36
category: 
	- 技术贴
	- Java
tags: 
    - invoke
    - 反射
---

# 什么是反射
反射是一种能够装载JVM中类内部信息的工具，运行时获取字节码文件，发起调用修改等一系列操作

## 反射慢？
1.验证等防御性代码过于繁琐，这部分耗时反射都需要在计算运行时执行，而不像正常逻辑在link阶段执行。
2.使用反射会产生大量的临时对象，对gc产生时间消耗
3.由于直接调取，缺少上下文，丢失很多运行时优化，如JIT
<!--more-->
### JIT
JIT(Just-In-Time Compiler),即时编译器,当虚拟机发现某个方法或代码块运行特别频繁时，就会把这些代码认定为“Hot Spot Code”（热点代码），为了提高热点代码的执行效率，在运行时，虚拟机将会把这些代码编译成与本地平台相关的机器码，并进行各层次的优化，完成这项任务的正是JIT编译器

说了这么多理论，也没太明白什么意思，先执行java -version
```
java version "1.8.0_111"
Java(TM) SE Runtime Environment (build 1.8.0_111-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)
```

这是博主的java运行环境，重点看mixed mode，代表混合模式，什么意思呢？其实Java虚拟机有三种执行方式，分别是解释执行、混合模式和编译执行，默认情况下处于混合模式中。在混合模式中，部分函数会被解释执行，部分可能被编译执行。虚拟机决定函数是否需要编译执行的依据是判断该函数，是否为热点代码。如果函数的调用频率很高，被反复使用，那么就会被认为是热点，热点代码就会被编译执行。

解释执行模式，表示全部代码均解释执行，不做任何JIT编译，可以使用参数-Xint来开启解释执行模式： 
```
java version "1.8.0_111"
Java(TM) SE Runtime Environment (build 1.8.0_111-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14,interpreted mode)
```

编译执行模式，对于所有的函数，无论是否是热点代码，都会被编译执行，使用参数-Xcomp可以设置为编译模式：
```
java version "1.8.0_111"
Java(TM) SE Runtime Environment (build 1.8.0_111-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14,compiled mode)
```

一个重要结论：编译模式的执行效率会远远高于解释模式！

#### 什么是热点代码
被多次调用的方法。
被多次调用的循环体。

#### 如何判断是热点代码－热点探测
**基于采样的热点探测：**
采用这种方法的虚拟机会周期性地检查各个线程的栈顶，如果发现某些方法经常出现在栈顶，那这段方法代码就是“热点代码”。这种探测方法的好处是实现简单高效，还可以很容易地获取方法调用关系，缺点是很难精确地确认一个方法的热度，容易因为受到线程阻塞或别的外界因素的影响而扰乱热点探测。
**基于计数器的热点探测：**
采用这种方法的虚拟机会为每个方法，甚至是代码块建立计数器，统计方法的执行次数，如果执行次数超过一定的阀值，就认为它是“热点方法”。这种统计方法实现复杂一些，需要为每个方法建立并维护计数器，而且不能直接获取到方法的调用关系，但是它的统计结果相对更加精确严谨。