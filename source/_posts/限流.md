---
title: 限流
toc: true
date: 2017-04-06 11:27:02
category: 
    - 技术贴
    - 理论与概念
tags: 
    - 限流
    - RateLimit

---

# 什么是限流
限流，意为限制流量，从字面上看就是对于某事物的过载保护，而对于互联网API服务来说，限流的作用至关重要，限流不仅仅对于后端服务可以起到保护作用，也能防止一系列不安全的请求进入后端服务，对于大型WEB应用，限流功能必不可少。

## 常用的限流措施
先分析限流的目的，网上截了一段用，不要在意
- 某个用户直接或间接造成了流量飙升，我们需要确保对其他用户服务可用。
- 某个用户向 API 服务发送大量请求。 或者更糟的是，某个用户试图恶意冲垮服务器。
- 用户发送了大量低优先级请求，但我们希望确保不会影响其他高优先级请求。 例如，发送大量分析数据请求的用户可能会影响其他用户的关键事务。
- 系统内部产生错误，导致无法处理所有请求，不得不丢弃低优先级的请求。
<!--more-->

### 来源请求限流
针对请求来源的限流器，如某个用户触发了客户端的bug(如死循环调用接口，别觉得没有可能)，或者点中了服务端的bug(博主就拿nginx+lua干出过一个死循环bug)，又或者就是恶意攻击，强刷接口，一般这类限流器主要就是控制用户访问频次，限制每个用户每秒可发送 N 个请求。常用的场景就是秒杀，抢购，防止恶意刷商品，刷票。

### 并发请求限流
并发请求限流就是最常见的一种限流策略，服务端api上线前一般都会进行压测，预估出当前服务集群可承受的最大请求量（TPS），这个时候并发请求限流器就可以设置最高并发请求数，超过这个值就直接返回，减少服务器压力。

### 基于资源的限流
这种限流可能要和监控挂钩了，这种限流之前我一直想过，但一直没有代码尝试过，基本原理我理解的是根据当前服务器的CPU使用率，内存使用空间，swap区使用大小等硬件资源来判断当前集群是否处于亚健康，如果是那么就对后端服务进行限流，通过过滤请求等方式减少当前服务负载，待恢复到一定阀值，再关闭限流器。

** 总结 **
以上几种限流器一般NGINX商业版都会提供（至少我司是这样），用户频次控制，粗细管道等，后端业务服务就不太需要刻意多做功能，但是针对下面两种情况，运维同学可能不会做这种个性化的限流，还需要后端自行完成。

### 基于优先级的负载降级
针对于并发请求限流，主要是针对整个集群提供的所有服务做的限流措施，但业务上对于请求也要区分核心业务（如创建视频，订单交易等等）／非核心业务（查询历史记录），那么对于核心业务肯定是要保证请求的完整性与服务的可用性，不能随随便便的就返回个error，而对于非核心业务，可能用户无感（比如push业务设备管理信息的更新），就可以在集群压力大的情况下抛弃一些请求，保证服务可用性，不影响核心业务。那么基于优先级的负载降级限流就是对每个请求做路由，根据不同的限流规则做限流功能。

### 基于work利用率的负载降级
work可以理解为工作进程，比如nginx的work工作者，那么对于服务来说，采用的负载均衡策略不同，可能每个work分摊到的工作（如请求）就不相同，有的work可能会忙，无法再处理新的请求，有的work可能比较闲。那么就可以根据这种情况对繁忙的work做降级，使服务均衡。


## 一些常用的限流工具
** Guava RateLimit **
这个工具我在我的breeze框架中使用，在这就不再多说了。
